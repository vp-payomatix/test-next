name: Deploy PR to test-front

on:
  pull_request_review:
    types: [submitted]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    if: github.event.review.state == 'approved'
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials (OIDC Secure Login)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_DEPLOY_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Trigger Deployment via SSM & Wait For Logs
        run: |
          PR=${{ github.event.pull_request.number }}

          echo "Deploying PR #$PR..."

          # 1) Send SSM Command
          CMD=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploying PR #$PR" \
            --timeout-seconds 60 \
            --parameters commands="sudo /opt/frontend-pr/deploy_front_pr.sh $PR" \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command ID: $CMD"

          # 2) Poll command status
          STATUS="InProgress"
          while [[ "$STATUS" == "InProgress" || "$STATUS" == "Pending" ]]; do
            echo "⏳ Waiting for SSM command to complete..."
            sleep 4
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$CMD" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --query "Status" \
              --output text 2>/dev/null || echo "Pending")
          done

          echo "Final Status: $STATUS"

          # 3) Print STDOUT
          echo "-------------------------"
          echo "STDOUT"
          echo "-------------------------"
          aws ssm get-command-invocation \
            --command-id "$CMD" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query "StandardOutputContent" \
            --output text

          # 4) Print STDERR
          echo "-------------------------"
          echo "STDERR"
          echo "-------------------------"
          aws ssm get-command-invocation \
            --command-id "$CMD" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query "StandardErrorContent" \
            --output text

          # 5) Mark Job failed if SSM failed
          if [[ "$STATUS" != "Success" ]]; then
            echo "❌ Deployment failed!"
            exit 1
          fi

          echo "✅ Deployment successful!"